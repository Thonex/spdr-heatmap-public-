<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Big Chart v2 — Sector & Industry Heatmap</title>
  <style>
    :root { --bg:#0b0f14; --panel:#111823; --text:#e6edf3; --muted:#9fb0c3; --accent:#3aa3ff; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--panel);position:sticky;top:0;z-index:2}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=url]{min-width:420px;max-width:58vw;padding:8px 10px;border-radius:10px;border:1px solid #2b3a4c;background:#0e141b;color:var(--text)}
    button, .pill{cursor:pointer;border:1px solid #2b3a4c;background:#0e141b;color:var(--text);padding:8px 12px;border-radius:999px}
    .pill.active{background:var(--accent);border-color:var(--accent);color:#06121e;font-weight:600}
    .toggle{display:flex;gap:6px;align-items:center;padding:4px;border-radius:999px;background:#0e141b;border:1px solid #2b3a4c}
    .toggle button{border:none;padding:6px 10px;border-radius:999px}
    .toggle button.active{background:var(--accent);color:#06121e;font-weight:600}
    .muted{color:var(--muted)}
    main{padding:16px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #1b2733;padding:6px 8px;text-align:center}
    th{position:sticky;top:58px;background:#0f1722;z-index:1}
    .cell{min-width:38px}
    .g{background:#0f3;color:#061}
    .y{background:#dd0;color:#3b2}
    .r{background:#b22;color:#fee}
    .legend{display:flex;gap:8px;align-items:center}
    .box{width:14px;height:14px;border-radius:3px;border:1px solid #0003}
    .box.g{background:#0f3}.box.y{background:#dd0}.box.r{background:#b22}
    .note{margin-top:6px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <span class="pill" id="pillSectors">Sectors</span>
      <span class="pill" id="pillIndustries">Industry Groups</span>
      <div class="toggle" title="Calculation engine">
        <button id="modeV1">CMF only</button>
        <button id="modeV2">Composite (Price+Flow)</button>
      </div>
      <button id="btnRefresh">Refresh</button>
      <div class="legend small">
        <span class="box g"></span> 80–99
        <span class="box y"></span> 60–79
        <span class="box r"></span> 0–59
      </div>
    </div>
    <div class="row">
      <label class="muted small">Active CSV URL</label>
      <input id="csvUrl" type="url" placeholder="Paste published CSV URL (output=csv)" />
      <button id="btnSaveUrl">Save URL</button>
    </div>
  </header>

  <main>
    <div class="note muted small">Tip: paste each dataset URL once and click <b>Save URL</b>. They’re stored in your browser (localStorage). Use the <b>Sectors / Industry Groups</b> pills to switch, then hit <b>Refresh</b> to reload.
    </div>
    <div id="status" class="small muted" style="margin:8px 0 14px"></div>
    <div id="tableWrap"></div>
  </main>

<script>
// ====== dataset storage ======
const KEYS = { sectors: 'heatmap_url_sectors', industries: 'heatmap_url_industries' };
const MODE_KEY = 'heatmap_mode'; // 'v1' or 'v2'

// Pre-fill Industry Groups with the URL you provided earlier
if (!localStorage.getItem(KEYS.industries)) {
  localStorage.setItem(KEYS.industries, 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwCu-AtG33jHIxKaVpP9kCCC3R_oQfvK6kumzG3WuUZGCwpSp1d1MoZxV3ESg7--NveInP2zEA2QVL/pub?gid=0&single=true&output=csv');
}

// Label maps so we can show Sector / Sector-Group before the ticker
const LABELS = {
  sectors: {
    XLB: 'Materials', XLE: 'Energy', XLF: 'Financials', XLI: 'Industrials', XLK: 'Information Technology',
    XLP: 'Consumer Staples', XLU: 'Utilities', XLV: 'Health Care', XLY: 'Consumer Discretionary', XLRE: 'Real Estate', XLC: 'Communication Services'
  },
  industries: {
    // ENERGY
    XOP: 'Energy – Oil & Gas E&P', OIH: 'Energy – Oil Services', FCG: 'Energy – Natural Gas',
    // MATERIALS
    XME: 'Materials – Metals & Mining', XLB: 'Materials – Broad',
    // INDUSTRIALS
    ITA: 'Industrials – Aerospace & Defense', IYT: 'Industrials – Transportation', PAVE: 'Industrials – Infrastructure', XLI: 'Industrials – Broad',
    // CONSUMER DISCRETIONARY
    ITB: 'Consumer Discretionary – Home Construction', AUTO: 'Consumer Discretionary – Autos/EV (composite)', XRT: 'Consumer Discretionary – Retail', XLY: 'Consumer Discretionary – Broad',
    // CONSUMER STAPLES
    XLP: 'Consumer Staples – Broad', VDC: 'Consumer Staples – Broad (Vanguard)',
    // HEALTH CARE
    IBB: 'Health Care – Biotechnology', IHI: 'Health Care – Medical Devices', PPH: 'Health Care – Pharmaceuticals', XLV: 'Health Care – Broad',
    // FINANCIALS
    KBE: 'Financials – Banks', KRE: 'Financials – Regional Banks', XLF: 'Financials – Broad',
    // REAL ESTATE
    XLRE: 'Real Estate – Select Sector REITs', VNQ: 'Real Estate – Broad', IYR: 'Real Estate – Broad (alt)',
    // INFORMATION TECHNOLOGY
    SOXX: 'Information Technology – Semiconductors', IGV: 'Information Technology – Software', FDN: 'Information Technology – Internet', CIBR: 'Information Technology – Cybersecurity', XLK: 'Information Technology – Broad',
    // COMMUNICATION SERVICES
    XLC: 'Communication Services – Broad', VOX: 'Communication Services – Telecom',
    // UTILITIES
    XLU: 'Utilities – Broad', FUTY: 'Utilities – Broad (alt)'
  }
};

let active = localStorage.getItem('heatmap_active') || 'industries';
let mode = localStorage.getItem(MODE_KEY) || 'v2';

const pillS = document.getElementById('pillSectors');
const pillI = document.getElementById('pillIndustries');
const modeV1 = document.getElementById('modeV1');
const modeV2 = document.getElementById('modeV2');
const urlInput = document.getElementById('csvUrl');
const btnSave = document.getElementById('btnSaveUrl');
const btnRefresh = document.getElementById('btnRefresh');
const statusEl = document.getElementById('status');

function setActive(which){
  active = which; localStorage.setItem('heatmap_active', which);
  pillS.classList.toggle('active', which==='sectors');
  pillI.classList.toggle('active', which==='industries');
  urlInput.value = localStorage.getItem(KEYS[which]) || '';
  modeV1.classList.toggle('active', mode==='v1');
  modeV2.classList.toggle('active', mode==='v2');
}

pillS.onclick = ()=>{ setActive('sectors'); };
pillI.onclick = ()=>{ setActive('industries'); };
modeV1.onclick = ()=>{ mode='v1'; localStorage.setItem(MODE_KEY, mode); setActive(active); };
modeV2.onclick = ()=>{ mode='v2'; localStorage.setItem(MODE_KEY, mode); setActive(active); };
btnSave.onclick = ()=>{
  const v = urlInput.value.trim();
  if(!v){ alert('Paste a published CSV URL first.'); return; }
  localStorage.setItem(KEYS[active], v);
  flash(`Saved ${active} URL.`);
};
btnRefresh.onclick = ()=> loadActive();

function flash(msg){ statusEl.textContent = msg; setTimeout(()=>statusEl.textContent='', 3000); }

setActive(active); };
modeV2.onclick = ()=>{ mode='v2'; localStorage.setItem(MODE_KEY, mode); setActive(active); };
btnSave.onclick = ()=>{
  const v = urlInput.value.trim();
  if(!v){ alert('Paste a published CSV URL first.'); return; }
  localStorage.setItem(KEYS[active], v);
  flash(`Saved ${active} URL.`);
};
btnRefresh.onclick = ()=> loadActive();

function flash(msg){ statusEl.textContent = msg; setTimeout(()=>statusEl.textContent='', 3000); }

setActive(active);

// ====== CSV → weekly CMF (v1) and Composite (v2) ======
async function loadActive(){
  const url = localStorage.getItem(KEYS[active]);
  if(!url){ alert(`No ${active} URL saved yet. Paste it above and click Save URL.`); return; }
  await buildHeatmap(url);
}

async function buildHeatmap(url){
  try{
    const needsProxy = location.protocol === 'file:';
    const proxied = needsProxy ? 'https://cors.isomorphic-git.org/' + url : url;
    const res = await fetch(proxied);
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const text = (await res.text()).replace(/^\uFEFF/, '').trim();
    const rows = text.split(/\r?\n/).map(r=>r.split(','));
    const header = rows.shift().map(h=>h.replace(/\uFEFF/g,'').trim().toLowerCase());
    const need = ['date','ticker','open','high','low','close','volume'];
    for(const k of need){ if(!header.includes(k)) throw new Error('Missing header: '+k); }
    const idx = Object.fromEntries(header.map((h,i)=>[h,i]));

    // Parse per-ticker daily bars
    const byT = {};
    for(const r of rows){
      const t = r[idx.ticker];
      const d = new Date(r[idx.date]);
      const o = +r[idx.open], h = +r[idx.high], l = +r[idx.low], c = +r[idx.close], v = +r[idx.volume];
      if(!t || !isFinite(c) || !isFinite(h) || !isFinite(l) || !isFinite(v) || h<=l) continue;
      (byT[t] ||= []).push({d,o,h,l,c,v});
    }
    for(const t in byT){ byT[t].sort((a,b)=>a.d-b.d); }

    // Week key (Friday end)
    function weekKey(dt){
      const x = new Date(dt); const wd = x.getUTCDay();
      const offset = wd === 6 ? 1: wd === 0 ? 2: 5-wd; // push to Fri
      x.setUTCDate(x.getUTCDate()+offset); x.setUTCHours(0,0,0,0);
      return x.toISOString().slice(0,10);
    }

    // Aggregate to weekly CMF & Return
    const weeks = new Set();
    const wkByT = {}; // t -> { w -> {cmf, ret} }
    for(const t in byT){
      const weekMap = {};
      let prevFriClose = null;
      let acc = {}; let curW = null;
      for(const bar of byT[t]){
        const w = weekKey(bar.d);
        if(curW && w !== curW){
          const cmf = acc.vol>0 ? acc.mfv/acc.vol : 0;
          const ret = (prevFriClose!=null && acc.close!=null && prevFriClose>0) ? (acc.close/prevFriClose - 1) : 0;
          weekMap[curW] = {cmf, ret};
          prevFriClose = acc.close; acc = {};
        }
        curW = w;
        const mfm = ((bar.c - bar.l) - (bar.h - bar.c)) / (bar.h - bar.l);
        const mfv = mfm * bar.v;
        acc.mfv = (acc.mfv||0) + (isFinite(mfv)? mfv: 0);
        acc.vol = (acc.vol||0) + (isFinite(bar.v)? bar.v: 0);
        acc.close = bar.c; weeks.add(w);
      }
      if(curW){
        const cmf = acc.vol>0 ? acc.mfv/acc.vol : 0;
        const ret = (prevFriClose!=null && acc.close!=null && prevFriClose>0) ? (acc.close/prevFriClose - 1) : 0;
        weekMap[curW] = {cmf, ret};
      }
      wkByT[t] = weekMap;
    }

    const wkArr = Array.from(weeks).sort().slice(-12); // last 12 weeks

    // v1 percentiles (CMF only)
    const pctV1 = {}; // t->{w:pct}
    for(const w of wkArr){
      const pair = [];
      for(const t in wkByT){ const hit = wkByT[t][w]; if(hit) pair.push([t, hit.cmf]); }
      pair.sort((a,b)=>a[1]-b[1]);
      const n = pair.length; pair.forEach((p,i)=>{ (pctV1[p[0]] ||= {})[w] = n>1 ? Math.round(i*100/(n-1)) : 50; });
    }

    // v2 composite: EWMA of CMF & Return → cross-section percentiles → 65/35 combine
    function ewma(arr, lambda){ let s=null; const out={}; for(const {w,value} of arr){ s=(s==null)?value:(lambda*s+(1-lambda)*value); out[w]=s; } return out; }
    const LAMBDA = 0.92; // ~7-week half-life (heavier recent weight)
    const flowEW = {}; const perfEW = {};
    for(const t in wkByT){
      const seqF = []; const seqR = [];
      for(const w of wkArr){ const hit = wkByT[t][w]; if(!hit) continue; seqF.push({w,value:hit.cmf}); seqR.push({w,value:hit.ret}); }
      flowEW[t] = ewma(seqF, LAMBDA);
      perfEW[t] = ewma(seqR, LAMBDA);
    }
    function xsecPercentiles(mapByTicker){
      const out = {}; for(const w of wkArr){ const pair = []; for(const t in mapByTicker){ if(mapByTicker[t][w]!=null) pair.push([t,mapByTicker[t][w]]); } pair.sort((a,b)=>a[1]-b[1]); const n=pair.length; pair.forEach((p,i)=>{ (out[p[0]] ||= {})[w] = n>1 ? Math.round(i*100/(n-1)) : 50; }); } return out; }
    const flowPct = xsecPercentiles(flowEW);
    const perfPct = xsecPercentiles(perfEW);
    const compPct = {}; // 65% Flow, 35% Perf
    for(const t in wkByT){ for(const w of wkArr){ const f=(flowPct[t]||{})[w]; const p=(perfPct[t]||{})[w]; if(f==null||p==null) continue; const v=Math.round(0.65*f + 0.35*p); (compPct[t] ||= {})[w]=v; } }

    // Render
    const names = Object.keys(wkByT).sort();
    const th = ['<th>Group</th>','<th>Ticker</th>'].concat(wkArr.map(w=>`<th class=\"cell\">${w.slice(5)}</th>`)).join('');
    let html = `<table><thead><tr>${th}</tr></thead><tbody>`;
    for(const t of names){
      const labelMap = LABELS[active] || {}; const label = labelMap[t] || '';
      html += `<tr><td style=\"text-align:left\">${label}</td><td>${t}</td>`;
      for(const w of wkArr){
        const val = (mode==='v2' ? (compPct[t]||{})[w] : (pctV1[t]||{})[w]);
        const cls = val==null? '' : (val>=80? 'g' : val>=60? 'y' : 'r');
        html += `<td class=\"cell ${cls}\">${val??''}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    document.getElementById('tableWrap').innerHTML = html;
    const modeLabel = (mode==='v2'?'Composite (Price+Flow)':'CMF only');
    flash(`Loaded ${names.length} tickers • ${wkArr.length} weeks from ${active} • Mode: ${modeLabel}.`);
  }catch(err){
    console.error(err);
    alert(err.message || 'Could not load/parse CSV');
  }
}

// Auto-load
loadActive();
</script>
</body>
</html>
