<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Big Chart v2 — Sector & Industry Heatmap</title>
  <style>
    :root { --bg:#0b0f14; --panel:#111823; --text:#e6edf3; --muted:#9fb0c3; --accent:#3aa3ff; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--panel);position:sticky;top:0;z-index:2}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=url]{min-width:420px;max-width:58vw;padding:8px 10px;border-radius:10px;border:1px solid #2b3a4c;background:#0e141b;color:var(--text)}
    button,.pill{cursor:pointer;border:1px solid #2b3a4c;background:#0e141b;color:var(--text);padding:8px 12px;border-radius:999px}
    .pill.active{background:var(--accent);border-color:var(--accent);color:#06121e;font-weight:600}
    .toggle{display:flex;gap:6px;align-items:center;padding:4px;border-radius:999px;background:#0e141b;border:1px solid #2b3a4c}
    .toggle button{border:none;padding:6px 10px;border-radius:999px}
    .toggle button.active{background:var(--accent);color:#06121e;font-weight:600}
    .muted{color:var(--muted)}
    main{padding:16px}
    table{border-collapse:collapse;width:100%}
th,td{border:1px solid #1b2733;padding:6px 8px;text-align:center}
th{position:sticky;top:58px;background:#0f1722;z-index:1}

/* final, authoritative rules */
.cell{ min-width:18px; padding:4px 6px; }   /* narrower cells */
.g{ background:#0f3; color:#061; }
/* yellow with dark text – keep only this one */
.y{ background:#ffea5a !important; color:#000 !important; }
.r{ background:#b22; color:#fee; }
    .r{background:#b22;color:#fee}
    .legend{display:flex;gap:8px;align-items:center}
    .box{width:14px;height:14px;border-radius:3px;border:1px solid #0003}
    .box.g{background:#0f3}.box.y{background:#ffea5a}.box.r{background:#b22}
    .note{margin-top:6px}
    .small{font-size:12px}
    td.label{text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;min-width:160px}
    th:first-child,td:first-child{max-width:200px;min-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    select{background:#0e141b;color:var(--text);border:1px solid #2b3a4c;border-radius:8px;padding:6px 8px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <span class="pill" id="pillSectors">Sectors</span>
      <span class="pill" id="pillIndustries">Industry Groups</span>

      <div class="toggle" title="Calculation engine">
        <button id="modeV1">CMF only</button>
        <button id="modeV2">Composite (Price+Flow)</button>
      </div>

      <div class="row">
        <label class="muted small">Sort by</label>
        <select id="sortBy" title="Sorting">
          <option value="ticker">Ticker (A→Z)</option>
          <option value="group">Group (A→Z)</option>
          <option value="latest">Latest week (desc)</option>
          <option id="optAvg" value="avgN">Window avg (desc)</option>
          <option value="mom4">4‑week momentum (desc)</option>
        </select>
      </div>

      <button id="btnRefresh">Refresh</button>

      <div class="legend small">
        <span class="box g"></span> 80–99
        <span class="box y"></span> 60–79
        <span class="box r"></span> 0–59
      </div>
    </div>

    <div class="row">
      <label class="muted small">Active CSV URL</label>
      <input id="csvUrl" type="url" placeholder="Paste published CSV URL (output=csv)" />
      <button id="btnSaveUrl">Save URL</button>
    </div>
    <div class="row">
      <label class="muted small">Lookback</label>
      <select id="lookbackN" title="Number of weeks">
        <option>8</option>
        <option selected>12</option>
        <option>16</option>
        <option>20</option>
        <option>26</option>
      </select>

      <label class="muted small">Half‑life (EWMA)</label>
      <select id="halfLife" title="Weeks for EWMA half‑life">
        <option>1</option>
        <option>2</option>
        <option>4</option>
        <option selected>7</option>
        <option>10</option>
        <option>12</option>
        <option>16</option>
      </select>
    </div>
  </header>

  <main>
    <div class="note muted small">
      Tip: paste each dataset URL once and click <b>Save URL</b>. They’re stored in your browser (localStorage) <b>per pill</b>.
      Use the <b>Sectors / Industry Groups</b> pills to switch, then hit <b>Refresh</b> to reload.
    </div>
    <div id="status" class="small muted" style="margin:8px 0 14px"></div>
    <div id="tableWrap"></div>
  </main>

<script>
const KEYS = { sectors: 'heatmap_url_sectors', industries: 'heatmap_url_industries' };
const MODE_KEY = 'heatmap_mode';

if (!localStorage.getItem(KEYS.industries)) {
  localStorage.setItem(KEYS.industries, 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwCu-AtG33jHIxKaVpP9kCCC3R_oQfvK6kumzG3WuUZGCwpSp1d1MoZxV3ESg7--NveInP2zEA2QVL/pub?gid=0&single=true&output=csv');
}

const LABELS = {
  sectors: {
    XLB:'Materials', XLE:'Energy', XLF:'Financials', XLI:'Industrials', XLK:'Information Technology',
    XLP:'Consumer Staples', XLU:'Utilities', XLV:'Health Care', XLY:'Consumer Discretionary',
    XLRE:'Real Estate', XLC:'Communication Services'
  },
  industries: {
    XOP:'Energy – Oil & Gas E&P', OIH:'Energy – Oil Services', FCG:'Energy – Natural Gas',
    XME:'Materials – Metals & Mining', XLB:'Materials – Broad',
    ITA:'Industrials – Aerospace & Defense', IYT:'Industrials – Transportation', PAVE:'Industrials – Infrastructure', XLI:'Industrials – Broad',
    ITB:'Consumer Discretionary – Home Construction', AUTO:'Consumer Discretionary – Autos/EV (composite)', XRT:'Consumer Discretionary – Retail', XLY:'Consumer Discretionary – Broad',
    XLP:'Consumer Staples – Broad', VDC:'Consumer Staples – Broad (Vanguard)',
    IBB:'Health Care – Biotechnology', IHI:'Health Care – Medical Devices', PPH:'Health Care – Pharmaceuticals', XLV:'Health Care – Broad',
    KBE:'Financials – Banks', KRE:'Financials – Regional Banks', XLF:'Financials – Broad',
    XLRE:'Real Estate – Select Sector REITs', VNQ:'Real Estate – Broad', IYR:'Real Estate – Broad (alt)',
    SOXX:'Information Technology – Semiconductors', IGV:'Information Technology – Software', FDN:'Information Technology – Internet', CIBR:'Information Technology – Cybersecurity', XLK:'Information Technology – Broad',
    XLC:'Communication Services – Broad', VOX:'Communication Services – Telecom',
    XLU:'Utilities – Broad', FUTY:'Utilities – Broad (alt)'
  }
};

let active = localStorage.getItem('heatmap_active') || 'industries';
let mode = localStorage.getItem(MODE_KEY) || 'v2';

const pillS = document.getElementById('pillSectors');
const pillI = document.getElementById('pillIndustries');
const modeV1 = document.getElementById('modeV1');
const modeV2 = document.getElementById('modeV2');
const urlInput = document.getElementById('csvUrl');
const btnSave = document.getElementById('btnSaveUrl');
const btnRefresh = document.getElementById('btnRefresh');
const statusEl = document.getElementById('status');
const sortSel = document.getElementById('sortBy');
const optAvg = document.getElementById('optAvg');

const N_KEY = 'heatmap_lookback_weeks';
const H_KEY = 'heatmap_half_life';
const lookSel = document.getElementById('lookbackN');
const halfSel = document.getElementById('halfLife');

let LOOKBACK_N = +(localStorage.getItem(N_KEY) || 12);
let HALF_LIFE  = +(localStorage.getItem(H_KEY) || 7);

if (lookSel) lookSel.value = String(LOOKBACK_N);
if (halfSel) halfSel.value = String(HALF_LIFE);
updateAvgOptionLabel();

lookSel.onchange = async () => {
  LOOKBACK_N = +lookSel.value;
  localStorage.setItem(N_KEY, LOOKBACK_N);
  updateAvgOptionLabel();
  await loadActive(); // rebuild from CSV to get full week set
};

halfSel.onchange = () => {
  HALF_LIFE = +halfSel.value;
  localStorage.setItem(H_KEY, HALF_LIFE);
  recomputeComposite(); // re-derive comp using new λ, no refetch
  render();
};

function updateAvgOptionLabel(){
  if (optAvg) optAvg.textContent = `${LOOKBACK_N}‑week avg (desc)`;
}

function setActive(which){
  active = which === 'sectors' ? 'sectors' : 'industries';
  localStorage.setItem('heatmap_active', active);
  pillS.classList.toggle('active', active==='sectors');
  pillI.classList.toggle('active', active==='industries');
  const saved = localStorage.getItem(KEYS[active]) || '';
  urlInput.value = saved;
  modeV1.classList.toggle('active', mode==='v1');
  modeV2.classList.toggle('active', mode==='v2');
  if (window._heat) render();
}

pillS.onclick = ()=>{ setActive('sectors'); };
pillI.onclick = ()=>{ setActive('industries'); };
modeV1.onclick = ()=>{ mode='v1'; localStorage.setItem(MODE_KEY, mode); setActive(active); render(); };
modeV2.onclick = ()=>{ mode='v2'; localStorage.setItem(MODE_KEY, mode); setActive(active); render(); };
btnSave.onclick = ()=>{
  const v = (urlInput?.value || '').trim();
  if(!v){ alert('Paste a published CSV URL first.'); return; }
  localStorage.setItem(KEYS[active], v);
  flash(`Saved ${active} URL.`);
};
btnRefresh.onclick = ()=> loadActive();
sortSel.onchange = ()=> render();

function flash(msg){ statusEl.textContent = msg; setTimeout(()=>statusEl.textContent='', 3000); }

async function loadActive(){
  const url = localStorage.getItem(KEYS[active]);
  if(!url){ alert(`No ${active} URL saved yet. Paste it above and click Save URL.`); return; }
  await buildHeatmap(url);
}

function weekKey(dt){
  // Map any date to the upcoming Friday (UTC)
  const x = new Date(dt);
  const wd = x.getUTCDay(); // 0=Sun ... 5=Fri 6=Sat
  const offset = (5 - wd + 7) % 7; // Sat->6, Sun->5, Fri->0, etc.
  x.setUTCDate(x.getUTCDate() + offset);
  x.setUTCHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}

function lambdaFromHalfLife(H){
  return Math.pow(0.5, 1/Math.max(1, H));
}

function ewma(arr, lambda){
  let s=null; const out={};
  for(const {w,value} of arr){
    s = (s==null) ? value : (lambda*s + (1-lambda)*value);
    out[w] = s;
  }
  return out;
}

async function buildHeatmap(url){
  try{
    const needsProxy = location.protocol === 'file:';
    const proxied = needsProxy ? 'https://cors.isomorphic-git.org/' + url : url;
    const res = await fetch(proxied);
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const text = (await res.text()).replace(/^\uFEFF/, '').trim();
    const rows = text.split(/\r?\n/).map(r=>r.split(','));
    const header = rows.shift().map(h=>h.replace(/\uFEFF/g,'').trim().toLowerCase());
    const need = ['date','ticker','open','high','low','close','volume'];
    for(const k of need){ if(!header.includes(k)) throw new Error('Missing header: '+k); }
    const idx = Object.fromEntries(header.map((h,i)=>[h,i]));

    // per-ticker daily bars
    const byT = {};
    for(const r of rows){
      const t = (r[idx.ticker]||'').toUpperCase();
      const d = new Date(r[idx.date]);
      const o = +r[idx.open], h = +r[idx.high], l = +r[idx.low], c = +r[idx.close], v = +r[idx.volume];
      if(!t || !isFinite(c) || !isFinite(h) || !isFinite(l) || !isFinite(v) || h<=l) continue;
      (byT[t] ||= []).push({d,o,h,l,c,v});
    }
    for(const t in byT){ byT[t].sort((a,b)=>a.d-b.d); }

    // Aggregate weekly CMF & Return
    const weeks = new Set();
    const wkByT = {};
    for(const t in byT){
      const weekMap = {};
      let prevFriClose = null;
      let acc = {}; let curW = null;
      for(const bar of byT[t]){
        const w = weekKey(bar.d);
        if(curW && w !== curW){
          const cmf = acc.vol>0 ? acc.mfv/acc.vol : 0;
          const ret = (prevFriClose!=null && acc.close!=null && prevFriClose>0) ? (acc.close/prevFriClose - 1) : 0;
          weekMap[curW] = {cmf, ret};
          prevFriClose = acc.close; acc = {};
        }
        curW = w;
        const mfm = ((bar.c - bar.l) - (bar.h - bar.c)) / (bar.h - bar.l);
        const mfv = mfm * bar.v;
        acc.mfv = (acc.mfv||0) + (isFinite(mfv)? mfv: 0);
        acc.vol = (acc.vol||0) + (isFinite(bar.v)? bar.v: 0);
        acc.close = bar.c; weeks.add(w);
      }
      if(curW){
        const cmf = acc.vol>0 ? acc.mfv/acc.vol : 0;
        const ret = (prevFriClose!=null && acc.close!=null && prevFriClose>0) ? (acc.close/prevFriClose - 1) : 0;
        weekMap[curW] = {cmf, ret};
      }
      wkByT[t] = weekMap;
    }

    // keep only the last LOOKBACK_N weeks
    const allWeeks = Array.from(weeks).sort();
    const wkArr = allWeeks.slice(-Math.max(1, LOOKBACK_N));

    // v1 (CMF-only) → cross-section percentiles each week
    const pctV1 = {};
    for(const w of wkArr){
      const pair = [];
      for(const t in wkByT){ const hit = wkByT[t][w]; if(hit) pair.push([t, hit.cmf]); }
      pair.sort((a,b)=>a[1]-b[1]);
      const n = pair.length; pair.forEach((p,i)=>{ (pctV1[p[0]] ||= {})[w] = n>1 ? Math.round(i*100/(n-1)) : 50; });
    }

    // Composite v2 computed with current HALF_LIFE
    const compPct = computeCompositePct(wkByT, wkArr, HALF_LIFE);

    // cache + render
    window._heat = { wkArr, pctV1, compPct, wkByT };
    render();
    const modeLabel = (mode==='v2'?'Composite (Price+Flow)':'CMF only');
    flash(`Loaded ${Object.keys(wkByT).length} tickers • ${wkArr.length} weeks from ${active} • Mode: ${modeLabel}.`);
  }catch(err){
    console.error(err);
    alert(err.message || 'Could not load/parse CSV');
  }
}

// recompute Composite using existing weekly data (no refetch)
function recomputeComposite(){
  const H = window._heat; if(!H) return;
  H.compPct = computeCompositePct(H.wkByT, H.wkArr, HALF_LIFE);
}

function computeCompositePct(wkByT, wkArr, halfLife){
  const LAMBDA = lambdaFromHalfLife(halfLife);
  const flowEW = {}; const perfEW = {};
  for(const t in wkByT){
    const seqF = []; const seqR = [];
    for(const w of wkArr){ const hit = wkByT[t][w]; if(!hit) continue; seqF.push({w,value:hit.cmf}); seqR.push({w,value:hit.ret}); }
    flowEW[t] = ewma(seqF, LAMBDA);
    perfEW[t] = ewma(seqR, LAMBDA);
  }
  function xsecPercentiles(mapByTicker){
    const out = {};
    for(const w of wkArr){
      const pair = [];
      for(const t in mapByTicker){ if(mapByTicker[t][w]!=null) pair.push([t,mapByTicker[t][w]]); }
      pair.sort((a,b)=>a[1]-b[1]);
      const n = pair.length; pair.forEach((p,i)=>{ (out[p[0]] ||= {})[w] = n>1 ? Math.round(i*100/(n-1)) : 50; });
    }
    return out;
  }
  const flowPct = xsecPercentiles(flowEW);
  const perfPct = xsecPercentiles(perfEW);
  const compPct = {};
  for(const t in wkByT){
    for(const w of wkArr){
      const f=(flowPct[t]||{})[w], p=(perfPct[t]||{})[w];
      if(f==null||p==null) continue;
      const v=Math.round(0.65*f + 0.35*p);
      (compPct[t] ||= {})[w]=v;
    }
  }
  return compPct;
}

// ====== sorting & rendering ======
function getVal(t,w){
  const H = window._heat; if(!H) return null;
  return mode==='v2' ? (H.compPct[t]||{})[w] : (H.pctV1[t]||{})[w];
}
function avg(arr){
  const f = arr.filter(v=>v!=null);
  return f.length ? Math.round(f.reduce((a,b)=>a+b,0)/f.length) : null;
}

function render(){
  const H = window._heat; if(!H) return;
  const { wkArr, wkByT } = H;
  const names = Object.keys(wkByT);
  const latest = wkArr[wkArr.length-1];
  const sortBy = (sortSel?.value)||'ticker';

  const rows = names.map(t=>{
    const label = (LABELS[active]||{})[t] || '';
    const series = wkArr.map(w => getVal(t,w));
    const latestVal = getVal(t, latest);
    const avgN = avg(series);
    const mom4 = (()=>{
      const i = wkArr.length-1, j = Math.max(0, wkArr.length-5);
      const a = getVal(t, wkArr[i]), b = (wkArr.length>4) ? getVal(t, wkArr[j]) : null;
      return (a!=null && b!=null) ? (a-b) : null;
    })();
    return { t, label, latestVal, avgN, mom4 };
  });

  rows.sort((A,B)=>{
    switch(sortBy){
      case 'group': return (A.label||'').localeCompare(B.label||'') || A.t.localeCompare(B.t);
      case 'latest': return (B.latestVal??-1) - (A.latestVal??-1) || A.t.localeCompare(B.t);
      case 'avgN':   return (B.avgN??-1)      - (A.avgN??-1)      || A.t.localeCompare(B.t);
      case 'mom4':   return (B.mom4??-1)      - (A.mom4??-1)      || A.t.localeCompare(B.t);
      default:       return A.t.localeCompare(B.t);
    }
  });

  const th = ['<th>Group</th>','<th>Ticker</th>']
             .concat(H.wkArr.map(w=>`<th class="cell">${w.slice(5)}</th>`)).join('');
  let html = `<table><thead><tr>${th}</tr></thead><tbody>`;
  for(const R of rows){
    html += `<tr><td class="label">${R.label}</td><td>${R.t}</td>`;
    for(const w of H.wkArr){
      const val = getVal(R.t, w);
      const cls = val==null? '' : (val>=80? 'g' : val>=60? 'y' : 'r');
      html += `<td class="cell ${cls}">${val??''}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('tableWrap').innerHTML = html;
}

window.addEventListener('DOMContentLoaded', () => {
  try {
    setActive(active);
    loadActive();
  } catch (e) {
    console.error(e);
    const s = document.getElementById('status');
    if (s) s.textContent = 'Init error: ' + (e.message || e);
  }
});
</script>
</body>
</html>
