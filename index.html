<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Big Chart v2 — Sector & Industry Heatmap</title>
  <style>
    :root { --bg:#0b0f14; --panel:#111823; --text:#e6edf3; --muted:#9fb0c3; --accent:#3aa3ff; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--panel);position:sticky;top:0;z-index:2}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,.pill{cursor:pointer;border:1px solid #2b3a4c;background:#0e141b;color:var(--text);padding:8px 12px;border-radius:999px}
    .pill.active{background:var(--accent);border-color:var(--accent);color:#06121e;font-weight:600}
    .toggle{display:flex;gap:6px;align-items:center;padding:4px;border-radius:999px;background:#0e141b;border:1px solid #2b3a4c}
    .toggle button{border:none;padding:6px 10px;border-radius:999px}
    .toggle button.active{background:var(--accent);color:#06121e;font-weight:600}
    .muted{color:var(--muted)}
    main{padding:16px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #1b2733;padding:6px 8px;text-align:center}
    th{position:sticky;top:58px;background:#0f1722;z-index:1}
    .cell{min-width:18px;padding:4px 6px}
    .g{background:#0f3;color:#061}
    .y{background:#ffea5a !important;color:#000 !important}
    .r{background:#b22;color:#fee}
    .legend{display:flex;gap:8px;align-items:center}
    .box{width:14px;height:14px;border-radius:3px;border:1px solid #0003}
    .box.g{background:#0f3}.box.y{background:#ffea5a}.box.r{background:#b22}
    .note{margin-top:6px}
    .small{font-size:12px}
    td.label{text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;min-width:160px}
    th:first-child,td:first-child{max-width:200px;min-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    select{background:#0e141b;color:var(--text);border:1px solid #2b3a4c;border-radius:8px;padding:6px 8px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <span class="pill" id="pillSectors">Sectors</span>
      <span class="pill" id="pillIndustries">Industry Groups</span>

      <div class="toggle" title="Calculation engine">
        <button id="modeV1">CMF only</button>
        <button id="modeV2">Composite (Price+Flow)</button>
      </div>

      <div class="row">
        <label class="muted small">Sort by</label>
        <select id="sortBy" title="Sorting">
          <option value="ticker">Ticker (A→Z)</option>
          <option value="group">Group (A→Z)</option>
          <option value="latest">Latest week (desc)</option>
          <option id="optAvg" value="avgN">Window avg (desc)</option>
          <option value="mom4">4-week momentum (desc)</option>
        </select>
      </div>

      <button id="btnRefresh">Refresh</button>

      <div class="legend small">
        <span class="box g"></span> 80–99
        <span class="box y"></span> 60–79
        <span class="box r"></span> 0–59
      </div>
    </div>

    <div class="row">
      <label class="muted small">Lookback</label>
      <select id="lookbackN" title="Number of weeks">
        <option>2</option>
        <option>4</option>
        <option>8</option>
        <option selected>12</option>
        <option>16</option>
        <option>18</option>
      </select>

      <label class="muted small">Half-life (EWMA)</label>
      <select id="halfLife" title="Weeks for EWMA half-life">
        <option>1</option>
        <option>2</option>
        <option>4</option>
        <option selected>7</option>
        <option>10</option>
        <option>12</option>
        <option>16</option>
      </select>
    </div>
  </header>

  <main>
    <div id="status" class="small muted" style="margin:8px 0 14px"></div>
    <div id="tableWrap"></div>
  </main>

<script>
const URLS = {
  sectors: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRb0KGQYJoXfcLSE9_HUGVV513UrBMn3M5DhtqJHDyXgYLamBBsKQDwo7rR6Lvu-dTvU82ex9nt2igO/pub?gid=0&single=true&output=csv",
  industries: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwCu-AtG33jHIxKaVpP9kCCC3R_oQfvK6kumzG3WuUZGCwpSp1d1MoZxV3ESg7--NveInP2zEA2QVL/pub?gid=0&single=true&output=csv"
};

let active = 'industries';
let mode = 'v2';

const pillS = document.getElementById('pillSectors');
const pillI = document.getElementById('pillIndustries');
const modeV1 = document.getElementById('modeV1');
const modeV2 = document.getElementById('modeV2');
const btnRefresh = document.getElementById('btnRefresh');
const statusEl = document.getElementById('status');
const sortSel = document.getElementById('sortBy');
const optAvg = document.getElementById('optAvg');
const lookSel = document.getElementById('lookbackN');
const halfSel = document.getElementById('halfLife');

let LOOKBACK_N = 12;
let HALF_LIFE  = 7;

lookSel.onchange = async () => {
  LOOKBACK_N = +lookSel.value;
  updateAvgOptionLabel();
  await loadActive();
};

halfSel.onchange = () => {
  HALF_LIFE = +halfSel.value;
  recomputeComposite();
  render();
};

function updateAvgOptionLabel(){
  if (optAvg) optAvg.textContent = `${LOOKBACK_N}-week avg (desc)`;
}

function setActive(which){
  active = which === 'sectors' ? 'sectors' : 'industries';
  pillS.classList.toggle('active', active==='sectors');
  pillI.classList.toggle('active', active==='industries');
  modeV1.classList.toggle('active', mode==='v1');
  modeV2.classList.toggle('active', mode==='v2');
  if (window._heat) render();
}

pillS.onclick = ()=>{ setActive('sectors'); loadActive(); };
pillI.onclick = ()=>{ setActive('industries'); loadActive(); };
modeV1.onclick = ()=>{ mode='v1'; setActive(active); render(); };
modeV2.onclick = ()=>{ mode='v2'; setActive(active); render(); };
btnRefresh.onclick = ()=> loadActive();
sortSel.onchange = ()=> render();

function flash(msg){ statusEl.textContent = msg; setTimeout(()=>statusEl.textContent='', 3000); }

async function loadActive(){
  const url = URLS[active];
  await buildHeatmap(url);
}

// ---- rest of your existing buildHeatmap, recomputeComposite, computeCompositePct, getVal, avg, render functions unchanged ----
</script>
</body>
</html>
